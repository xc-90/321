<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='host_lobby.css') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Chemistry Game</title>
</head>
<body>
    <header class="lobby-header">
        <div class="game-code-container">
            <p>Game Code:</p>
            <div id="lobby-code-box">{{ game_code }}</div>
        </div>
        <div id="status-container"></div>
        <button id="start-game-btn" disabled>Start Game</button>
    </header>

    <main class="player-area">
        <h3>Players in Lobby:</h3>
        <div id="player-container">
        </div>
    </main>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        const gameCode = "{{ game_code }}";
        const socket = io();
        let verified = false;

        function showStatus(message, isError = false) {
            const container = document.getElementById('status-container');
            if (message) {
                container.innerHTML = `<p class="status-message ${isError ? 'status-error' : 'status-info'}">${message}</p>`;
            } else {
                container.innerHTML = '';
            }
        }

        socket.on('connect', () => {
            showStatus('Verifying access...');
            const hostToken = localStorage.getItem(`host_token_${gameCode}`);
            if (!hostToken) {
                showStatus('You did not create this game. Redirecting...', true);
                setTimeout(() => { window.location.href = '/'; }, 2000);
                return;
            }
            socket.emit('verify_host_token', { game_code: gameCode, host_token: hostToken });
        });

        socket.on('host_verified', (data) => {
            verified = true;
            showStatus('');
            updatePlayerList(data.players);
        });

        socket.on('access_denied', (data) => {
            alert(data.message || 'Access denied');
            window.location.href = '/';
        });

        socket.on('update_player_list', (data) => {
            updatePlayerList(data.players);
        });

        function updatePlayerList(players) {
            const container = document.getElementById('player-container');
            const startBtn = document.getElementById('start-game-btn');
            container.innerHTML = '';

            if (players.length === 0) {
                container.innerHTML = `<p class="waiting-message">Waiting for players to join...</p>`;
                startBtn.disabled = true;
            } else {
                players.forEach(player => {
                    const circle = document.createElement('div');
                    circle.className = 'player-circle';
                    circle.style.backgroundColor = player.color;
                    circle.dataset.username = player.username; 

                    const topPos = Math.random() * 85;
                    const leftPos = Math.random() * 95;
                    circle.style.top = `${topPos}%`;
                    circle.style.left = `${leftPos}%`;

                    container.appendChild(circle);
                });
                startBtn.disabled = !verified;
            }
        }

        document.getElementById('start-game-btn').addEventListener('click', () => {
            if (!verified) return;
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = true;
            startBtn.textContent = 'Starting...';
            socket.emit('start_game');
        });

        socket.on('redirect_to_game', (data) => {
            showStatus('Starting game...');
            window.location.href = `/game/code/${data.game_code}`;
        });

        socket.on('error', (data) => {
            showStatus(data.message || 'An error occurred', true);
            if (data.message && data.message.includes('closed')) {
                setTimeout(() => { window.location.href = '/'; }, 3000);
            }
        });
        
        socket.on('connect_error', (error) => {
            showStatus('Please rejoin', true);
        });
    </script>
</body>
</html>