<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='student_lobby.css') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Chemistry Game</title>
</head>
<body>
    <header class="lobby-header">
        <h2>Student Lobby</h2>
        <p>Game Code: <strong id="game-code-display">{{ game_code }}</strong></p>
        <p class="you-indicator">You are: <strong id="your-username">...</strong></p>
        <p class="status-message"><em>Waiting for the host to start the game...</em></p>
    </header>

    <main class="player-area">
        <h3>Players in Lobby:</h3>
        <div id="player-container">
        </div>
    </main>

    <div class="chat-container">
        <div id="chat-messages" class="chat-messages"></div>
        <form id="chat-form" class="chat-form">
            <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" required maxlength="100">
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        const gameCode = "{{ game_code }}";
        const username = localStorage.getItem(`username_${gameCode}`);
        
        if (!username) {
            alert('Username not found. Please rejoin.');
            window.location.href = '/join';
        }
        
        document.getElementById('your-username').textContent = username;
        const yourUsernameEl = document.getElementById('your-username');
        const yourIndicatorEl = yourUsernameEl.parentElement;

        const socket = io();

        socket.on('connect', () => {
            socket.emit('join_game', { game_code: gameCode, username: username });
        });

        socket.on('join_success', (data) => {
            if (data.color) {
                localStorage.setItem(`color_${gameCode}`, data.color);
                yourIndicatorEl.style.borderColor = data.color;
                yourUsernameEl.style.color = data.color;
            }
        });

        socket.on('banned', (data) => {
         localStorage.setItem('no', 'true');
            alert(data.message);
            window.location.href = '/';
       });

        socket.on('update_player_list', (data) => {
            const container = document.getElementById('player-container');
            container.innerHTML = '';

            if (data.players.length === 0) {
                container.innerHTML = `<p class="waiting-message">Waiting for players...</p>`;
                return;
            }
            
            data.players.forEach(player => {
                const circle = document.createElement('div');
                circle.className = 'player-circle';
                circle.style.backgroundColor = player.color;
                circle.dataset.username = player.username;
                
                if (player.username === username) {
                    circle.classList.add('is-you');
                }

                const topPos = Math.random() * 85;
                const leftPos = Math.random() * 95;
                circle.style.top = `${topPos}%`;
                circle.style.left = `${leftPos}%`;

                container.appendChild(circle);
            });
        });

        socket.on('redirect_to_game', (data) => {
            window.location.href = `/game/code/${data.game_code}`;
        });

        socket.on('error', (data) => {
            alert(data.message || 'An error occurred');
            if (data.message && (data.message.includes('closed') || data.message.includes('not found'))) {
                setTimeout(() => { window.location.href = '/'; }, 1000);
            }
        });

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                socket.emit('send_message', { message: message });
                chatInput.value = '';

                sendButton.disabled = true;
                setTimeout(() => {
                    sendButton.disabled = false;
                    chatInput.focus();
                }, 1000);
            }
        });

        socket.on('new_message', (data) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');

            const userSpan = document.createElement('span');
            userSpan.classList.add('user');
            userSpan.textContent = `${data.user}: `;
            userSpan.style.color = data.color;

            messageElement.appendChild(userSpan);

            messageElement.append(document.createTextNode(data.text));

            chatMessages.appendChild(messageElement);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

    </script>
</body>
</html>